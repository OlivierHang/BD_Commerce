{% extends 'base.html.twig' %}

{% block title %}Panier - BD Commerce
{% endblock %}
{% block js %}
	<script src="https://js.stripe.com/v3/"></script>
{% endblock %}

{% block content %}

	{% if panier is defined %}
		{# <pre>
																																																																																										    {{ dump(panier) }}
																																																																																										</pre> #}

		<table class="table">
			<thead>
				<tr>
					<th scope="col">Ref</th>
					<th scope="col">Couverture</th>
					<th scope="col">Titre</th>
					<th scope="col">Quantite</th>
					<th scope="col">Prix (unite)</th>
					<th scope="col">Prix</th>
					<th scope="col"></th>
				</tr>
			</thead>
			<tbody>
				{% set total = null %}
				{% set quantite = null %}

				{% for item in panier %}
					<tr>
						<td>
							{{ item.bd.ref }}
						</td>
						<td><img src="{{ asset('couv/') }}{{ item.bd.image }}" height="100px"></td>
						<td>{{ item.bd.titre }}</td>
						<td>
							{{ item.quantite }}
							<a href="{{ path('add_to_panier', {'ref' : item.bd.ref}) }}"><img src="{{ asset('assets/img/plus.png') }}" height="10px"></a>
							<a href="{{ path('decrease_from_panier', {'ref' : item.bd.ref}) }}"><img src="{{ asset('assets/img/minus.png') }}" height="10px"></a>
						</td>
						<td>{{ item.bd.prixPublic }}€</td>
						<td>{{ item.bd.prixPublic * item.quantite }}€</td>
						<td>
							<a href="{{ path('delete_from_panier', { 'ref' : item.bd.ref }) }}"><img src="{{ asset('assets/img/del.png') }}" height="20px"></a>
						</td>
					</tr>

					{% set total = total + (item.bd.prixPublic * item.quantite ) %}
					{% set quantite = quantite + item.quantite %}

				{% endfor %}
			</tbody>
		</table>
		<hr>
		<div class="text-right mb-5">
			<p>
				Sous-total ({{quantite}}
				articles):
				<b>{{total}}€</b>
			</p>

			{# <a href="{{ path('stripe_create_session') }}" class="btn btn-success mb-1">Commander</a><br> #}
			<a class="btn btn-success mb-1" id="checkout-button">Commander</a><br>
			<a href="{{ path('remove_panier') }}" class="btn btn-danger">Vider le panier</a>
		</div>
	{% else %}
		<p class="text-center">
			Vous n'avez pas de BD dans votre panier
		</p>
	{% endif %}
{% endblock %}

{% block script %}
	<script type="text/javascript">

		// Create an instance of the Stripe object with your publishable API key

var stripe = Stripe("pk_test_51IY7XADH5SafTNx8JecDMTpHLPhtD6XiWnB6mmLoJ8iczxB8FFjwRhuB5p3J9RXep9v7Q2zFNA2oMVLUutQV7JHD00Zarap09x");

var checkoutButton = document.getElementById("checkout-button");

checkoutButton.addEventListener("click", function () {

fetch("/commande/create-session", {method: "POST"}).then(function (response) {

return response.json();

}).then(function (session) {

return stripe.redirectToCheckout({sessionId: session.id});

}).then(function (result) {

// If redirectToCheckout fails due to a browser or network

// error, you should display the localized error message to your

// customer using error.message.

if (result.error) {

alert(result.error.message);

}

}).catch(function (error) {

console.error("MF ! Error:", error);

});

});

	</script>
{% endblock %}
